# Test Fixtures Contract
# Defines the structure and validation rules for test fixtures

version: "1.0"
description: "Contract for TestBoost test fixtures"

fixtures:
  llm_responses:
    description: "Pre-recorded LLM responses for unit testing"
    location: "tests/fixtures/llm_responses/"
    format: "json"

    providers:
      - name: gemini
        file: gemini_responses.json
        operations:
          - analyze_class
          - generate_unit_tests
          - generate_integration_tests
          - analyze_dependencies

      - name: claude
        file: claude_responses.json
        operations:
          - analyze_class
          - generate_unit_tests
          - generate_integration_tests
          - analyze_dependencies

      - name: openai
        file: openai_responses.json
        operations:
          - analyze_class
          - generate_unit_tests
          - generate_integration_tests
          - analyze_dependencies

    schema:
      type: object
      required:
        - operation
        - response
      properties:
        operation:
          type: string
          description: "Operation identifier"
        input_context:
          type: object
          description: "Input that triggered this response"
        response:
          type: object
          description: "Mocked LLM response"
        tokens_used:
          type: integer
          minimum: 0
          description: "Simulated token usage"

  database:
    description: "Test data for database operations"
    location: "tests/fixtures/database/"
    format: "yaml"

    tables:
      - sessions
      - steps
      - events
      - artifacts
      - projects
      - project_locks

    schema:
      type: object
      required:
        - table
        - records
      properties:
        table:
          type: string
          enum: [sessions, steps, events, artifacts, projects, project_locks]
        records:
          type: array
          items:
            type: object
        cleanup:
          type: boolean
          default: true

  maven_projects:
    description: "Sample Maven project structures for testing"
    location: "tests/fixtures/test_projects/"

    projects:
      - name: simple-project
        description: "Single module project with basic dependencies"
        files:
          - pom.xml
          - src/main/java/com/example/App.java

      - name: multi-module
        description: "Multi-module project structure"
        files:
          - pom.xml
          - module-a/pom.xml
          - module-b/pom.xml

      - name: spring-boot
        description: "Spring Boot project with common starters"
        files:
          - pom.xml
          - src/main/java/com/example/Application.java
          - src/main/resources/application.yml

pytest_fixtures:
  description: "pytest fixtures defined in conftest.py"
  location: "tests/conftest.py"

  fixtures:
    - name: client
      scope: function
      description: "Async HTTP client for API testing"
      yields: "httpx.AsyncClient"

    - name: db_session
      scope: function
      description: "Database session with transaction rollback"
      yields: "sqlalchemy.ext.asyncio.AsyncSession"

    - name: mock_llm
      scope: function
      description: "Mocked LLM provider with JSON fixtures"
      yields: "unittest.mock.MagicMock"

    - name: test_project
      scope: session
      description: "Temporary Maven project directory"
      yields: "pathlib.Path"

    - name: mock_docker
      scope: function
      description: "Mocked Docker client for deployment tests"
      yields: "unittest.mock.MagicMock"

markers:
  description: "Custom pytest markers"

  markers:
    - name: integration
      description: "Marks test as integration test (requires external services)"
      usage: "@pytest.mark.integration"

    - name: slow
      description: "Marks test as slow (>1s expected)"
      usage: "@pytest.mark.slow"

    - name: flaky
      description: "Marks test as potentially flaky (allows retries)"
      usage: "@pytest.mark.flaky(reruns=2)"

    - name: requires_docker
      description: "Marks test as requiring Docker"
      usage: "@pytest.mark.requires_docker"

    - name: requires_db
      description: "Marks test as requiring PostgreSQL"
      usage: "@pytest.mark.requires_db"

ci_workflow:
  description: "GitHub Actions workflow contract"
  location: ".github/workflows/tests.yml"

  jobs:
    test:
      runs_on: ubuntu-latest
      services:
        - postgres:15

      steps:
        - checkout
        - setup_python: "3.11"
        - install_dependencies
        - run_tests:
            command: "pytest tests/ -n auto --cov=src --junitxml=test-results.xml"
        - upload_coverage

      outputs:
        - test-results.xml (JUnit format)
        - coverage.xml (Cobertura format)
